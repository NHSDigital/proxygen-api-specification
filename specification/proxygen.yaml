openapi: 3.0.3
info:
  title: Proxy Generator API
  version: __VERSION__  # Automatically populated by `scripts/calculate_version.py` at release-time
  description: |
    <div class="nhsd-m-emphasis-box nhsd-m-emphasis-box--emphasis nhsd-!t-margin-bottom-6" aria-label="Highlighted Information">
        <div class="nhsd-a-box nhsd-a-box--border-blue">
            <div class="nhsd-m-emphasis-box__image-box">
                <figure class="nhsd-a-image">
                    <picture class="nhsd-a-image__picture">
                        <img src="http://digital.nhs.uk/binaries/content/gallery/icons/info.svg?colour=231f20" alt="" style="object-fit:fill">
                    </picture>
                </figure>
            </div>
            <div class="nhsd-m-emphasis-box__content-box">
                <div data-uipath="website.contentblock.emphasis.content" class="nhsd-t-word-break"><p class="nhsd-t-body">This API is <a href="https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#statuses">in production, beta but internal</a>, meaning the API is not currently available for integration by external third parties. If you want to use it, <a href="https://digital.nhs.uk/developer/help-and-support">contact us</a> and we'll look at making it available.</p></div>
            </div>
        </div>
    </div>

    ## Overview
    Use this API to create and manage resources on NHS England's [API platform](https://digital.nhs.uk/services/api-platform).
    This API is intended for API producers [building healthcare APIs](https://digital.nhs.uk/services/api-platform/building-healthcare-apis).

    You can:
    * register new API definitions
    * publish API specifications
    * manage containers and secrets
    * use your OAS specification to manage API proxies, products and security patterns

    In the future, you will be able to:
    * secure the connection to your target service (back end) with TLS-MA (currently only API Key security is supported)
    * manage preview and live versions of your API's specification

    ## Who can use this API
    This API is only for use by teams building APIs on our API platform. These are predominantly internal NHS England teams.

    ## API status and roadmap
    This API is in [production, beta but internal](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#statuses), meaning:
    * we might make breaking changes, but only if we cannot avoid it, and we will give advance notice
    * it is only available for internal NHS England users

    ## Service level
    This API is a bronze service, meaning it is operational and supported only during business hours (8am to 6pm), Monday to Friday excluding bank holidays.
    
    For more details, see [service levels](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#service-levels).

    ## Technology
    This API is [RESTful](https://digital.nhs.uk/developer/guides-and-documentation/api-technologies-at-nhs-digital#basic-rest-apis).

    ## Network access
    This API is available on the internet.
    
    For more details see [Network access for APIs](https://digital.nhs.uk/developer/guides-and-documentation/network-access-for-apis).

    ## Security and authorisation

    This API supports [application-restricted](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation#application-restricted-apis) access.
    We are working on [user-restricted](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation#user-restricted-apis) access. 

    ### Application-restricted access

    To use this access mode, use the following security pattern:

    - [Application-restricted RESTful API - signed JWT authentication](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication)

    > The instructions in the above guide are valid, but the implementation details/endpoints differ, as explained below.

    In application-restricted access mode a token is obtained by performing a *client credentials* grant request, with an assertion type of `jwt-bearer` (a signed JWT).

    #### Requirements

    During API registration ([POST /apis](#post-apis)) a **public key** is supplied as a JWKS endpoint.

    A 'machine user' **client** is created with a client ID of `<api_name>-client` and is associated with this public key.

    You use this client ID and the corresponding **private key** to authenticate against our authorisation server and obtain an access token.

    #### Example

    To authenticate as the `hello-world` API machine user, having:

    - a Client ID of `hello-world-client`
    - a private key file
    - The KID of the corresponding public key in the JWKS endpoint: `prod-1`

    ```python
    import uuid
    from time import time

    import requests
    import jwt  # pyjwt library

    REALM_URL = "https://identity.prod.api.platform.nhs.uk/realms/api-producers"
    PRIVATE_KEY_FILE = "./hello-world-client-prod-1.key"  # absolute path
    KID = "prod-1"

    claims = {
        "sub": CLIENT_ID,
        "iss": CLIENT_ID,
        "jti": str(uuid.uuid4()),
        "aud": REALM_URL,
        "exp": int(time()) + 300,
    }

    with open(PRIVATE_KEY_FILE, "r") as f:
        private_key = f.read()

    client_assertion = jwt.encode(
      claims, private_key, algorithm="RS512", headers={'kid': KID}
    )

    token_response = requests.post(
        f"{REALM_URL}/protocol/openid-connect/token",
        data={
            "grant_type": "client_credentials",
            "client_assertion_type": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
            "client_assertion": client_assertion,
        },
    )

    access_token = token_response.json()["access_token"]

    # Make a request to a protected endpoint
    response = requests.get(
        "https://proxygen.prod.api.platform.nhs.uk/apis/hello-world",
        headers={"Authorization": f"Bearer {access_token}"},
    )
    ```

    ### User-restricted access
    Not supported yet. Requires implementation of back-end verification with TLS-MA, which is currently in development.

    ## Environments and testing
    Use the production instance of Proxy Generator API to deploy APIs to all environments.

    The base URL is `https://proxygen.prod.api.platform.nhs.uk`.

    ## Onboarding
    To use this API, you need to [engage with us as an API producer team](https://digital.nhs.uk/services/api-platform/building-healthcare-apis#getting-started).
    
    ## Errors
    We use standard HTTP status codes to show whether an API request succeeded or not. They are usually in the range:

    * 200 to 299 if it succeeded, including code 202 if it was accepted by an API that needs to wait for further action
    * 400 to 499 if it failed because of a client error by your application
    * 500 to 599 if it failed because of an error on our server

    Errors specific to each API are shown in the Endpoints section, under Response. See our [reference guide](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#http-status-codes) for more on errors.

    ## Concepts and terminology

    ### API

    The top-level concept in Proxy Generator API. Uniquely identified by its kebab-case **API name**.

    > The example API in this documentation is `hello-world`

    An API is typically created with the following **pre-requisite resources**:

    - **Machine client**:
    an OAuth v2 client that can be directly authenticated against, secured by a public-private keypair, with permissions to perform operations against this API. Intended for use in CI/CD pipelines. In our example API the client ID is `hello-world-client`.
    See [Authorisation](#authorisation).
    - **Docker repositories**:
    an API may have one or more associated Docker Repositories. These are typically used to store container images which can be referenced in API instances as *hosted targets*.
    See [GET /apis/{api_name}/docker-token](#get-apis-api_name-docker-token) and the `target` section of the OAS Extension reference.
    - **Keycloak policies and permissions**:
    the ability to act on APIs in Proxy Generator API is controlled by a permission model implemented in a separate authentication and authorisation provider: Keycloak.
    See [Security and authorisation](#security-and-authorisation).
    - **API registry entry**:
    a central registry of each API. The name (for example `hello-world`), short name (for example `hw`) are recorded against a GUID. This allows tracking of APIs through name changes and provides a canonical reference of everything on the API Platform.

    These pre-requisite resources can be updated or enabled/disabled after creation.

    ### Specification

    Each API may have a single OpenAPI specification (v3.0.3) which will be published on the [API catalogue](https://digital.nhs.uk/developer/api-catalogue) for reference by API consumers. Refer to the [Writing your API documentation](https://nhsd-confluence.digital.nhs.uk/display/APM/Writing+your+API+documentation) section of the API Platform Confluence space for guidance and best practices.

    #### API specification vs instance specification

    An 'API specification' is distinct from the 'instance specification' which drives the creation of API *instances*.

    | Specification type | Endpoints | Purpose | API catalogue |
    | --- | --- | --- | --- |
    | API specification | `GET`, `PUT` `/apis/{api_name}/spec`<br>`GET` `/specs/{api_name}` | Reference for the API (service) as a whole. | Publishes to the API catalogue |
    | Instance specification | `POST` `/apis/{api_name}/environments/{environment}/instances`<br>`GET`, `PUT` `/apis/{api_name}/environments/{environment}/instances/{instance_name}` | Manages an API instance | Does not publish to the API catalogue |

    ### Environments, instances and secrets

    #### Environments

    API instances and secrets are deployed into a specific *environment*. Environments are logically divided into three categories:

    - **Internal path to live** -  `internal-dev`, `internal-dev-sandbox`, `internal-qa-sandbox`, `internal-qa`, `internal-qa-sandbox`, `ref`:
    used by API producers in the development and testing of API proxies.
    - **External path to live** - `sandbox`, `dev`, `int`:
    used by API consumers in their development of services integrating with the API Platform
    - **Production** - `prod`:
    the live environment.

    > All environments are treated equally with the exception of **production** which requires additional permissions.

    #### Instances

    API *instances* are configured from a supplied **instance-specific OpenAPI specification** (OAS).

    > See [OpenAPI specification constraints and extensions](#openapi-specification-constraints-and-extensions) for the full explanation of the format of this specification.

    An API instance is essentially an API proxy which routes requests to some back-end service. It is deployed in a specific *environment.*

    An API instance has an **instance name** which is derived from the base path of the `servers.0.server.url` property of the OAS.

    > A server URL of `https://internal-dev.api.service.nhs.uk/hello-world-pr-123` would map to the instance name `hello-world-pr-123`

    An API instance may:

    - have one or more **API products** for API consumers to subscribe to
    - implement **rate limiting**
    - send traffic to a **back-end service** or a **hosted container**
    - implement one or more **security patterns** controlling how API clients can authenticate

    ##### Temporary instances

    API resources are limited across the platform and in order to keep deployed resources manageable, API producer teams are allocated a limited number of conncurrently deployed API instances. Once this limit is reached, deployments will fail. In order to keep this manageable for producers, there are a number of batch jobs which delete API instances which are marked as `temporary` periodically, based on their `last_modified` date.

    Examples of when the `temporary` attribute would be appropriate include, but are not limited to:
    - on creation of a pull request (PR) - these instances are often used for automated testing
    - during penetration testing
    - during load testing

    #### Secrets

    Proxy Generator API can be used to store secret values - primarily for use by proxies which are configured for externally hosted target servers. Secrets have a `_type` attribute, which indicate their upstream use. Currently supported secret types are:

    - `apikey` - used when employing API Key security between the API platform and back-end 'target' servers - this will be added to HTTP requests to the target as the value of the 'apikey' header.

    ## OpenAPI specification constraints and extensions

    ### Constraints

    #### OpenAPI version restriction to 3.0.3
    ##### Schema path: `openapi`
    For example: `openapi: 3.0.3`

    #### List of servers must contain a single item
    ##### Schema path: `servers`
    For example:
    ```
    servers:
     - url: 'https://internal-dev-sandbox.api.service.nhs.uk/hello-world'
    ```

    #### Security schema constraints
    ##### Schema path: `components.securitySchemes`
    A distinct list of security schemes referred to in the [security](https://swagger.io/specification/#security-requirement-object) property of path [Operations Objects](https://swagger.io/specification/#operation-object) defined within this spec.

    For example:
    ```
    securitySchemes:  # limit this to only those used in your API
      nhs-login-p0:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/nhs-login-p0
    nhs-login-p5:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/nhs-login-p5
    nhs-login-p9:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/nhs-login-p9
    nhs-cis2-aal1:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/nhs-cis2-aal1
    nhs-cis2-aal3:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/nhs-cis2-aal3
    app-level0:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/app-level0
    app-level3:
      $ref: https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/app-level3
    ```
    Each item references a publically available JSON description object, which is rendered into the final specification document.

    ### Extensions
    #### x-nhsd-apim
    This custom extension to the OpenAPI specification describes the API back-end and is the primary source of information for infrastructure to be deployed by Proxy Generator API.
    See the schema definition below for a full list of available/required attributes.

  license:
    name: MIT
  contact:
    name: API Management Support
    email: api.management@nhs.net
    url: 'https://digital.nhs.uk/developer/help-and-support'
x-spec-publication:
  operation-order:
    - group: APIs
      operations:
        - method: GET
          path: /apis
        - method: POST
          path: /apis
        - method: PUT
          path: /apis/{api-name}
        - method: DELETE
          path: /apis/{api-name}
    - group: Specifications
      operations:
        - method: GET
          path: /specs
        - method: GET
          path: /specs/{api_name}
        - method: GET
          path: /apis/{api-name}/spec
        - method: PUT
          path: /apis/{api-name}/spec
        - method: DELETE
          path: /apis/{api-name}/spec
    - group: Resources
      operations:
        - method: GET
          path: /apis/{api-name}
        - method: GET
          path: /apis/{api-name}/docker-token
        - method: GET
          path: /apis/{api_name}/environments
        - method: GET
          path: /apis/{api_name}/environments/{environment}
        - method: GET
          path: /apis/{api_name}/environments/{environment}/secrets
        - method: PUT
          path: /apis/{api_name}/environments/{environment}/secrets/{secret_name}
        - method: DELETE
          path: /apis/{api_name}/environments/{environment}/secrets/{secret_name}
        - method: GET
          path: /apis/{api_name}/environments/{environment}/secrets/{secret_name}
    - group: Instances
      operations:
        - method: GET
          path: /apis/{api-name}/environments/{environment}/instances
        - method: POST
          path: /apis/{api-name}/environments/{environment}/instances
        - method: GET
          path: /apis/{api-name}/environments/{environment}/instances/{instance_name}
        - method: PUT
          path: /apis/{api-name}/environments/{environment}/instances/{instance_name}
        - method: DELETE
          path: /apis/{api-name}/environments/{environment}/instances/{instance_name}

  try-this-api:
    disabled: true
servers:
  - url: 'https://internal-dev.api.service.nhs.uk/proxygen-specification'
    description: Dummy environment. Required to appease Proxy Generator API's OAS Parser which requires server URLs of a particular format.
paths:
  /apis:
    get:
      summary: List all APIs
      description: |-
        Get a list of all API names.

        > This operation requires the **admin** permission, users can contact API Management support to get an up-to-date list.
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                  example: hello-world
              examples:
                api-list:
                  value:
                    - hello-world
                    - personal-demographics
      operationId: get-apis
      parameters: []
    post:
      summary: Register a new API
      operationId: post-apis
      description: |-
        Register a new API with Proxy Generator API.

        > This operation requires the **admin** permission.

        Registers a new API with Proxy Generator API, creating the following pre-requisite resources:

        ### Keycloak policies and permissions
        When `keycloak` is set to `true` (the default) policies and permissions are created in keycloak. These are required to permit access to users and machine clients to perform operations on this API through Proxy Generator API.

        ### Machine client
        When `keycloak` is set to `true` and a `keycloak_client_jwks_resource_url` is provided a machine client is created with client ID `{api-name}-client` with permissions to perform operations on this API through Proxy Generator API. See Security and Authorisation section above.

        ### API Registry entry
        Creates an entry in the API registry unless `api_registry_entry` is set to `false`.

        ### Docker repositories
        The default behaviour is to create an [Elastic Container Registry](https://aws.amazon.com/ecr/) (ECR) Docker Repository for this API with the same name as the API.

        Set `docker_repositories` to an empty list (`[]`) to skip creation of a repository.

        Create one or more repositories with different names by setting the `docker_repositories` array. Repository names must start with (or be the same as) the API name.
      responses:
        '201':
          description: New API created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Api'
              examples:
                hello-world-api-created:
                  value:
                    name: hello-world
                    api_registry_entry: true
                    keycloak: true
                    keycloak_client_jwks_resource_url: 'https://example.org/jwks'
                    docker_repositories:
                      - hello-world
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Api'
            examples:
              create-hello-world-api:
                value:
                  name: hello-world
                  api_registry_entry: true
                  keycloak: true
                  keycloak_client_jwks_resource_url: 'https://example.org/jwks'
                  docker_repositories:
                    - hello-world
  '/apis/{api_name}':
    parameters:
      - schema:
          type: string
          example: hello-world
        name: api_name
        in: path
        required: true
    get:
      summary: Get an API's deployed resources
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/resource'
              examples:
                get-all-resources:
                  value:
                    - spec_hash: 437b930db84b8079c2dd804a71936b5f
                      temporary: true
                      type: instance
                      environment: internal-dev
                      name: hello-world-123
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - type: secret
                      apikey: false
                      version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                      environment: internal-dev
                      name: some-secret
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - spec_hash: 437b930db84b8079c2dd804a71936b5f
                      temporary: true
                      type: instance
                      environment: internal-qa
                      name: hello-world-321
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - type: secret
                      apikey: false
                      version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                      environment: internal-qa
                      name: some-other-secret
                      last_modified: '2022-10-12T11:39:45+00:00'
      operationId: get-apis-api_name
      description: |-
        Get a list of the deployed resources for an API.

        > This operations requires the read permission for the specific API

        Resource can be either 'secrets' or 'instances' (API proxies).

        Resources in *all* environments are listed.
    put:
      summary: Update an existing API
      operationId: put-apis-api_name
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Api'
              examples:
                update-api-response:
                  value:
                    name: hello-world
                    api_registry_entry: true
                    keycloak: true
                    keycloak_client_jwks_resource_url: 'https://example.org/new-jwks-endpoint'
                    docker_repositories:
                      - hello-world
                      - hello-world-auxiliary
        '422':
          description: Unprocessable Entity (WebDAV)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPException'
              examples:
                Example 1:
                  value:
                    detail: Path parameter api_name='hello-world' does match request body 'something-else'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Api'
            examples:
              update-api:
                value:
                  name: hello-world
                  api_registry_entry: true
                  keycloak: true
                  keycloak_client_jwks_resource_url: 'https://example.org/new-jwks-endpoint'
                  docker_repositories:
                    - hello-world
                    - hello-world-auxiliary
      description: |-
        Change the pre-requisite resources for an existing API. You can update anything except the API name.

        > This operation requires the update permission for the specific API

        See [POST /apis](#post-apis) for details of the semantics of the request.
    delete:
      summary: Delete an API
      operationId: delete-apis-api_name
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Api'
              examples:
                delete-api:
                  value:
                    name: hello-world
                    api_registry_entry: false
                    keycloak: false
                    keycloak_client_jwks_resource_url: ''
                    docker_repositories: []
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPException'
              examples:
                Example 1:
                  value:
                    detail: Cannot delete API with deployed resources.
      description: |-
        Delete an API. The API must have no deployed resources for the operation to succeed.

        > This operation requires the delete permission for the specific API
  '/apis/{api_name}/docker-token':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
    get:
      summary: Get a container registry access token
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: string
                  password:
                    type: string
                  registry:
                    type: string
                  expiresAt:
                    type: string
                    format: date-time
              examples:
                docker-token:
                  value:
                    user: AWS
                    password: '**********************'
                    registry: 'https://958002497996.dkr.ecr.eu-west-2.amazonaws.com'
                    expiresAt: '2022-10-26T02:05:39.540000+01:00'
      operationId: get-apis-api_name-docker-token
      description: |
        Get an access token for an API's container registries.

        > This operation requires the read permission for the specific API

        An API may have one or more associated Elastic Container Registry (ECR) Docker repositories associated with it - see the [PUT /apis/{api_name}](#put-apis-api_name) and [POST /apis](#post-apis).

        Use this endpoint to retrieve a short-lived access token (a username and password) and registry URI to access the registry:

        ```
        $ docker login --username <user> --password <password> <registry>
        ```
  '/apis/{api_name}/spec':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
    get:
      summary: Get the Specification for an API
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaasOpenAPI'
              examples:
                api-spec:
                  $ref: '#/components/examples/api-oas'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPException'
              examples:
                Example 1:
                  value:
                    detail: Not found
      operationId: get-apis-api_name-spec
      requestBody:
        content: {}
      description: |-
        Get an API's OpenAPI Specification (OAS).

        > This operation require the read permission for the specific API

        An API may have an OAS format specification which is (or will be) published on the [API Catalogue](https://digital.nhs.uk/developer/api-catalogue).

        Note that this is distinct from the OAS files that drive the generation of API's 'instances' (deployed API proxies). Instance-specific OAS files are typically derived from this specification, but include Proxy Generator API-specific extensions.
    put:
      summary: Create or replace the specification for an API
      operationId: put-apis-api_name-spec
      responses:
        '200':
          description: Successful request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaasOpenAPI'
              examples:
                put-spec-response:
                  $ref: '#/components/examples/api-oas'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaasOpenAPI'
            examples:
              update-api-specification:
                $ref: '#/components/examples/api-oas'
      description: |-
        Create or replace (update) an API's OAS specification.

        > This operation requires the update permission for the specific API
    delete:
      summary: Delete the specification for an API
      operationId: delete-apis-api_name-spec
      responses:
        '204':
          description: Specification deleted successfully
      description: |-
        Delete an API's OpenAPI Specification (OAS).

        > This operation requires the delete permission for the specific API

        An API may have an OAS format specification which is (or will be) published on the [API Catalogue](https://digital.nhs.uk/developer/api-catalogue), however this is not mandatory. Using this operation you can delete the API's specification.
  '/apis/{api_name}/environments':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
    get:
      summary: Get an API's deployed resources (optionally just a specific type)
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/resource'
              examples:
                get-resources-all-environments:
                  value:
                    - spec_hash: 437b930db84b8079c2dd804a71936b5f
                      temporary: true
                      type: instance
                      environment: internal-dev
                      name: hello-world-123
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - type: secret
                      apikey: false
                      version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                      environment: internal-dev
                      name: some-secret
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - spec_hash: 437b930db84b8079c2dd804a71936b5f
                      temporary: true
                      type: instance
                      environment: internal-qa
                      name: hello-world-321
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - type: secret
                      apikey: false
                      version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                      environment: internal-qa
                      name: some-other-secret
                      last_modified: '2022-10-12T11:39:45+00:00'
      operationId: get-apis-api_name-environments
      parameters:
        - schema:
            type: string
            enum:
              - instance
              - secret
            example: instance
          in: query
          name: _type
      description: |-
        Get a list of the deployed resources for an API.

        > This operations requires the read permission for the specific API

        Resource can be either 'secrets' or 'instances' (API proxies).

        Retrieve instances of a specific type using the optional `_type` query parameter.

        Resources in *all* environments are listed.
  '/apis/{api_name}/environments/{environment}':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
      - schema:
          type: string
        name: environment
        in: path
        required: true
    get:
      summary: Get an API's deployed resources for a specific environment
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/resource'
              examples:
                get-resources-specific-environment:
                  value:
                    - spec_hash: 437b930db84b8079c2dd804a71936b5f
                      temporary: true
                      type: instance
                      environment: internal-dev
                      name: hello-world-123
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - type: secret
                      apikey: false
                      version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                      environment: internal-dev
                      name: some-secret
                      last_modified: '2022-10-12T11:39:45+00:00'
      operationId: get-apis-api_name-environments-environment
      description: |-
        Get a list of the deployed resources for an API, in a specific environment.

        > This operations requires the read permission for the specific API

        Resource can be either 'secrets' or 'instances' (API proxies).
  '/apis/{api_name}/environments/{environment}/secrets':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
      - schema:
          type: string
        name: environment
        in: path
        required: true
    get:
      summary: Get the secrets for an API in a specific environment
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/secret'
              examples:
                get-secrets-for-environment:
                  value:
                    - type: secret
                      apikey: true
                      version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                      environment: internal-dev
                      name: some-secret
                      last_modified: '2022-10-12T11:39:45+00:00'
                    - type: secret
                      apikey: true
                      version_id: 4e03f1bd-f6d4-415e-bf04-10640136f031
                      environment: internal-dev
                      name: some-other-secret
                      last_modified: '2022-10-10T10:12:25+00:00'
      operationId: get-apis-api_name-environments-environment-secrets
      description: |-
        Get a list of stored secrets for an API, in a specific environment.

        > This operations requires the read permission for the specific API
  '/apis/{api_name}/environments/{environment}/secrets/{secret_name}':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
      - schema:
          type: string
        name: environment
        in: path
        required: true
      - in: path
        name: secret_name
        schema:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
          minLength: 1
          maxLength: 400
          example: some-secret
        required: true
    put:
      summary: Create or update a secret
      operationId: put-apis-api_name-environments-environment-secrets-secret_name
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/secret'
              examples:
                put-secret-response:
                  value:
                    name: my-secret
                    type: secret
                    last_modified: '2019-08-24T14:15:22Z'
                    environment: internal-dev
                    apikey: false
                    version_id: 9e94c502-ca41-4342-a7f7-af96b444512c
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPException'
              examples:
                Example 1:
                  value:
                    detail: Request body cannot be empty
      requestBody:
        content:
          text/plain:
            schema:
              type: string
              minLength: 1
            examples: {}
      parameters:
        - schema:
            type: string
            enum:
              - apikey
          in: query
          name: _type
      description: |-
        Create or update a secret or API Key

        > This operation requires the update permission for the specific API

        Create a named secret using this operation, specifying the secret name (key) in the path and secret value to be stored in the body of the request.

        If the secret already exists it will be updated.

        Optionally set the query parameter `_type=apikey` to mark this secret as an API Key which can be used to secure the connection between an instance (API Proxy) and back-end (target).
    delete:
      summary: Delete a secret or API key
      operationId: delete-apis-api_name-environments-environment-secrets-secret_name
      responses:
        '200':
          description: Secret deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/secret'
              examples:
                delete-secret:
                  value:
                    type: secret
                    apikey: false
                    version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                    environment: internal-dev
                    name: some-secret
                    last_modified: '2022-10-12T11:39:45+00:00'
      description: |-
        Delete a secret or API Key

        > This operation requires the delete permission for the specific API
    get:
      summary: Get the metadata for a specific secret
      operationId: get-apis-api_name-environments-environment-secrets-secret_name
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/secret'
              examples:
                get_secret:
                  value:
                    type: secret
                    apikey: false
                    version_id: 106a9942-210f-4f43-9735-a9310a34daa7
                    environment: internal-dev
                    name: some-secret
                    last_modified: '2022-10-12T11:39:45+00:00'
      description: |-
        Get secret metadata for a specific secret.

        > This operation requires the read permission for the specific API
  '/apis/{api_name}/environments/{environment}/instances':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
      - schema:
          type: string
        name: environment
        in: path
        required: true
    get:
      summary: Get the instances of an API in a specific environment
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/instance'
              examples:
                get-instances-specific-environment:
                  value:
                    - spec_hash: 437b930db84b8079c2dd804a71936b5f
                      temporary: true
                      type: instance
                      environment: internal-dev
                      name: hello-world-123
                      last_modified: '2022-10-12T11:39:45+00:00'
      operationId: get-apis-api_name-environments-environment-instances
      description: |
        Get a list of the deployed instances (API Proxies and associated API Products) for a given API and environment.

        > This operations requires the read permission for the specific API
    post:
      summary: Create an API instance in a specific environment
      operationId: post-apis-api_name-environments-environment-instances
      responses:
        '201':
          description: Instance created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaasOpenAPI'
              examples:
                create-instance-post-response:
                  $ref: '#/components/examples/instance-oas'
        '409':
          description: Failed to create instance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPException'
              examples:
                failed-to-create-instance:
                  value:
                    detail: API hello-world already has an instance hello-world-123 in internal-dev
      description: |-
        Create a new instance of this API in the specified environment.

        > This operation requires the create permission for the specific API

        The name of the created instance is determined by base path of the server url.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaasOpenAPI'
            examples:
              create-instance-post-body-example:
                $ref: '#/components/examples/instance-oas'
  '/apis/{api_name}/environments/{environment}/instances/{instance_name}':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
      - schema:
          type: string
        name: environment
        in: path
        required: true
      - schema:
          type: string
        name: instance_name
        in: path
        required: true
    get:
      summary: Get a specific API instance
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaasOpenAPI'
              examples:
                get-instance:
                  $ref: '#/components/examples/instance-oas'
      operationId: get-apis-api_name-environments-environment-instances-instance_name
      description: |-
        Get the instance-specific OAS file defining a specific API instance.

        > This operation requires the read permission for the specific API
    put:
      summary: Update or create an API instance
      operationId: put-apis-api_name-environments-environment-instances-instance_name
      responses:
        '200':
          description: Instance created or updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaasOpenAPI'
              examples:
                put-instance-response:
                  $ref: '#/components/examples/instance-oas'
      description: |-
        Update or create a named API instance

        > This operation requires the update permission for the specific API

        Created a named API instance using this operation.

        If the instance already exists it will be updated.

        The instance name supplied in the path parameter must match the one derived from the `servers.0.server.url` base path.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaasOpenAPI'
            examples:
              put-instance-body:
                $ref: '#/components/examples/instance-oas'
    delete:
      summary: Delete an API instance
      operationId: delete-apis-api_name-environments-environment-instances-instance_name
      responses:
        '200':
          description: Instance deleted
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPException'
              examples:
                Example 1:
                  value:
                    detail: No instance hello-world-123 in environment internal-dev
      description: |-
        Delete an API instance

        > This operation requires the delete permission for the specific API
  /specs:
    get:
      summary: Get all specifications
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    spec_id:
                      type: string
                      example: hello-world
                      description: Synonymous with `api_name` found in other contexts
                    last_modified:
                      type: string
                      format: date-time
              examples:
                get-all-specs:
                  value:
                    - spec_id: hello-world
                      last_modified: '2019-08-24T14:15:22Z'
                    - spec_id: personal-demographics
                      last_modified: '2019-08-22T12:14:11Z'
      operationId: get-specs
      description: |-
        Get a list of all API specifications and their last-modified dates.

        > This operation requires the special `spec-resource` permission

        The specifications listed are the API specification (those accessed through the [GET /apis/{api_name}/spec](#get-apis-api_name-spec) endpoints) and not the instance-specific specifications.

        In the returned object `spec_id` is synonymous with `api_name` found in other contexts.
  '/specs/{api_name}':
    parameters:
      - schema:
          type: string
        name: api_name
        in: path
        required: true
    get:
      summary: Get an API specification
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaasOpenAPI'
              examples:
                get-spec:
                  $ref: '#/components/examples/api-oas'
      operationId: get-specs-api_name
      description: |-
        Get a specific API specification.

        > This operation requires the special `spec-resource` permission

        The specification is API specification as you might access through the [GET /apis/{api_name}/spec](#get-apis-api_name-spec) endpoint and not the instance-specific specification.
components:
  schemas:
    Api:
      title: Api
      type: object
      properties:
        name:
          type: string
          description: API Name
          example: hello-world
        api_registry_entry:
          type: boolean
          default: true
          description: Whether to create an entry in the API Registry
        keycloak:
          type: boolean
          default: true
          description: Whether to create Keycloak permissions for this API. Keycloak permissions are required to allow users/machine clients other than those with the admin permission to administer this API
        keycloak_client_jwks_resource_url:
          description: The JWKS resource URL holding the public key for the default machine user admin client.
          example: 'https://example.org/jwks-endpoint'
          type: string
        docker_repositories:
          type: array
          uniqueItems: true
          description: "Defaults to one repository with the same name as the API name.\r\n\r\nNames must be the same as, or start with, the API name.\r\n\r\nSend an empty list to have no repositories."
          items:
            type: string
            example: hello-world
      required:
        - name
    HTTPException:
      title: HTTPException
      type: object
      properties:
        detail:
          type: string
    LITERAL_ENVS:
      title: LITERAL_ENVS
      enum:
        - internal-dev
        - internal-dev-sandbox
        - internal-qa
        - internal-qa-sandbox
        - ref
        - dev
        - int
        - sandbox
        - prod
      description: ''
    base_resource:
      title: base_resource
      type: object
      x-examples: {}
      properties:
        environment:
          $ref: '#/components/schemas/LITERAL_ENVS'
        name:
          type: string
          example: hello-world-123
        last_modified:
          type: string
          format: date-time
          example: '2022-10-12T11:39:45+00:00'
    PaasOpenAPI:
      title: OAS v3.0.3 Specification with Proxy Generator API-specific constraints and extensions
      description: |-
        Many Proxy Generator API endpoints accept or return an OpenAPI Specification with some additional constraints and a [specification extension](https://swagger.io/docs/specification/openapi-extensions/).

        Unfortunately the schema for an OAS cannot be represented in another OAS (this Proxy Generator API specification) due to the lack of support for `patternProperties`. This is a **partial/incomplete** representation of that schema, with a specific focus on the Proxy Generator API-specific constraints and extensions.

        Many properties are left 'empty' (eg `type: object`) where they are unmodified. Where there are Proxy Generator API-specific constraints on fields, the original sibling fields are typically included.

        Please also refer to the [OpenAPI Specification version 3.0.3](https://swagger.io/specification/v3/) reference.
      type: object
      required:
        - openapi
        - info
        - servers
        - paths
      properties:
        openapi:
          type: string
          enum:
            - 3.0.3
        info:
          type: object
        externalDocs:
          type: object
        servers:
          type: array
          minLength: 1
          items:
            type: object
            required:
              - url
            properties:
              url:
                type: string
                pattern: '^https://(internal-dev.api|internal-dev-sandbox.api|internal-qa.api|internal-qa-sandbox.api|ref.api|dev.api|int.api|sandbox.api|api).service.nhs.uk/((([a-zA-Z0-9])+[-/]?)+([a-zA-Z0-9])+)$'
              description:
                type: string
              variables:
                type: object
        security:
          type: array
          items:
            $ref: '#/components/schemas/PaasSecurityRequirement'
        tags:
          type: array
        paths:
          type: object
          properties:
            '^\/':
              type: object
              description: Some (any) path
              properties:
                summary:
                  type: string
                description:
                  type: string
                servers:
                  type: array
                parameters:
                  type: array
                get:
                  $ref: '#/components/schemas/Operation'
                put:
                  $ref: '#/components/schemas/Operation'
                post:
                  $ref: '#/components/schemas/Operation'
                delete:
                  $ref: '#/components/schemas/Operation'
                options:
                  $ref: '#/components/schemas/Operation'
                head:
                  $ref: '#/components/schemas/Operation'
                patch:
                  $ref: '#/components/schemas/Operation'
                trace:
                  $ref: '#/components/schemas/Operation'
        components:
          type: object
        x-nhsd-apim:
          $ref: '#/components/schemas/XNhsdApim'
    Operation:
      type: object
      properties:
        tags:
          type: array
        summary:
          type: string
        description:
          type: string
        externalDocs:
          type: object
        operationId:
          type: string
        servers:
          type: array
        security:
          $ref: '#/components/schemas/PaasSecurityRequirement'
        deprecated:
          type: boolean
        responses:
          type: object
        parameters:
          type: object
    PaasSecurityRequirement:
      type: object
      allOf:
        - $ref: '#/components/schemas/_PaasSecurity'
    EmptyList:
      type: array
      maxItems: 0
    _PaasSecurity:
      type: object
      title: _PaasSecurity
      description: Some description
      oneOf:
        - properties:
            app_level0:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - app_level0
        - properties:
            app_level3:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - app_level3
        - properties:
            nhs_login_p0:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - nhs_login_p0
        - properties:
            nhs_login_p5:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - nhs_login_p5
        - properties:
            nhs_login_p9:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - nhs_login_p9
        - properties:
            nhs_cis2_aal1:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - nhs_cis2_aal1
        - properties:
            nhs_cis2_aal3:
              $ref: '#/components/schemas/EmptyList'
          additionalProperties: false
          required:
            - nhs_cis2_aal3
      x-examples:
        Example 1:
          app_level0: []
    XNhsdApim:
      type: object
      description: |
        This section defines the infrastructure and resources required to deploy the Proxy.
      properties:
        target:
          $ref: '#/components/schemas/Target'
        access:
          type: array
          description: Defines a list of API Products to be deployed within the API Platform.
          items:
            $ref: '#/components/schemas/Access'
        ratelimiting:
          $ref: '#/components/schemas/RateLimiting'
        monitoring:
          description: Adds _ping and _status endpoints to the list of endpoints to be monitored
          type: boolean
          default: true
        temporary:
          type: boolean
          default: false
    Target:
      description: Describes the API back-end and therefore associated infrastructure for deployment.
      allOf:
        - $ref: '#/components/schemas/BaseTarget'
      oneOf:
        - $ref: '#/components/schemas/HostedTarget'
        - $ref: '#/components/schemas/ExternalTarget'
    BaseTarget:
      type: object
      properties:
        healthcheck:
          description: The path of the healthcheck endpoint on the back-end.
          type: string
          pattern: ^/
    Access:
      type: object
      required:
        - title
        - grants
      properties:
        title:
          type: string
        grants:
          $ref: '#/components/schemas/PaasSecurityAccess'
        visible:
          type: boolean
          default: true
    PaasSecurityAccess:
      type: object
      description: Grant access to this view using items defined in `securitySchemes`
      allOf:
        - $ref: '#/components/schemas/_PaasSecurity'
    HostedTarget:
      type: object
      description: The back-end target is hosted using Docker container(s) within the API Platform.
      required:
        - containers
        - type
      properties:
        type:
          type: string
          enum:
            - hosted
        containers:
          description: A list of Docker containers to deploy with each API instance.
          type: array
          minItems: 1
          maxItems: 5
          uniqueItems: true
          items:
            $ref: '#/components/schemas/Container'
    Container:
      type: object
      required:
        - name
        - image
      properties:
        name:
          type: string
        image:
          $ref: '#/components/schemas/Image'
        environment:
          description: Environment variables
          type: object
        primary:
          description: The primary container is the one which will handle incoming requests. It is expected that this container exposes HTTP port 9000.
          type: boolean
    Image:
      type: object
      description: A container image whihch must be available in the AWS ECR.
      required:
        - name
        - tag
      properties:
        name:
          type: string
        tag:
          type: string
    ExternalTarget:
      type: object
      description: The API back-end is hosted externally to the API Platform. Reqeusts will be sent sent out to the provided URL.
      required:
        - url
        - security
        - type
      properties:
        type:
          type: string
          enum:
            - external
        url:
          type: string
          format: uri
        security:
          $ref: '#/components/schemas/APIKeyBackendSecurity'
    APIKeyBackendSecurity:
      type: object
      description: A target back-end which is secured using an API key, which will be included in the configured HTTP request header.
      required:
        - type
        - header
        - secret
      properties:
        header:
          type: string
          description: The name of the HTTP header, added by the API Platform, which will contain the API key.
          example: apikey (the default)
        secret:
          type: string
          description: The name of a `secret` resource, which must already be deployed into the relevant environment.
        type:
          type: string
          enum:
            - apikey
    RateLimiting:
      type: object
      description: Rate limits can be described per-proxy and/or a default for the entire app.
      properties:
        proxy:
          $ref: '#/components/schemas/RateLimit'
        app_default:
          $ref: '#/components/schemas/RateLimit'
    RateLimit:
      type: object
      required:
        - timeunit
        - limit
      properties:
        timeunit:
          type: string
          enum:
            - second
            - minute
            - hour
        limit:
          type: integer
          minimum: 0
    instance:
      title: instance
      allOf:
        - type: object
          properties:
            spec_hash:
              type: string
              example: 437b930db84b8079c2dd804a71936b5f
              description: The md5 hash of the OAS defining this instance
            temporary:
              type: boolean
              default: false
              description: "Whether the instance is marked as temporary.\r\n\r\nTemporary instances are periodically removed, subject to their `last_modified` date."
            type:
              enum:
                - instance
        - $ref: '#/components/schemas/base_resource'
      x-examples:
        Example 1:
          spec_hash: string
          temporary: false
          type: instance
          environment: internal-dev
          name: hello-world-123
          last_modified: '2022-10-12T11:39:45+00:00'
    resource:
      oneOf:
        - $ref: '#/components/schemas/instance'
        - $ref: '#/components/schemas/secret'
      title: resource
    secret:
      title: secret
      allOf:
        - type: object
          properties:
            type:
              enum:
                - secret
            apikey:
              type: boolean
            version_id:
              type: string
              format: uuid
              example: 106a9942-210f-4f43-9735-a9310a34daa7
        - $ref: '#/components/schemas/base_resource'
  securitySchemes: {}
  examples:
    instance-oas:
      value:
        openapi: 3.0.3
        info:
          version: 0.0.1
          title: Hello World API
          description: |
            ## Overview
            Use this API alongside our  [tutorials](https://digital.nhs.uk/developer/guides-and-documentation/tutorials) to teach yourself how to connect to our RESTful APIs.
            You can:
             - get a response from an open-access endpoint, where the calling application and the end users are not authenticated
             - get a response from an application-restricted endpoint, where the calling application is authenticated but the end user is not authenticated
             - get a response from a user-restricted endpoint, where the calling application and the end user are authenticated
          contact:
            name: API Management Support
            email: api.management@nhs.net
        servers:
          - url: 'https://sandbox.api.service.nhs.uk/specification/hello-world'
            description: Sandbox environment.
        paths:
          /hello/world:
            get:
              summary: Get a "Hello world!" response from an open-access endpoint
              operationId: getHello
              security:
                - app-level0: []
              description: |
                ## Overview
                Use this endpoint alongside our [open-access REST API tutorial](https://digital.nhs.uk/developer/guides-and-documentation/tutorials/open-access-rest-api-tutorial) to learn how to connect to our APIs.
              responses:
                '200':
                  description: Successful response.
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          message:
                            type: string
                            example: Hello world!
                      example:
                        message: Hello world!
        components:
          securitySchemes:
            app-level0:
              \$ref: 'https://proxygen.ptl.api.platform.nhs.uk/components/securitySchemes/app-level0'
        x-nhsd-apim:
          monitoring: true
          access:
            - title: Application Restricted
              grants:
                app-level0: []
          target:
            type: hosted
            healthcheck: /_status
            containers:
              - name: hello-world
                image:
                  name: hello-world_hello-world
                  tag: 72537-sha6c0ccdb
                environment:
                  LOG_LEVEL: info
                  UPSTREAM: 'https://internal-dev.api.service.nhs.uk'
                  NODE_ENV: production
          ratelimiting:
            proxy:
              limit: 5
              timeunit: minute
            app-default:
              limit: 10
              timeunit: minute
    api-oas:
      value:
        openapi: 3.0.3
        info:
          version: 0.0.1
          title: Hello World API
          description: |
            ## Overview
            Use this API alongside our  [tutorials](https://digital.nhs.uk/developer/guides-and-documentation/tutorials) to teach yourself how to connect to our RESTful APIs.
            You can:
             - get a response from an open-access endpoint, where the calling application and the end users are not authenticated
             - get a response from an application-restricted endpoint, where the calling application is authenticated but the end user is not authenticated
             - get a response from a user-restricted endpoint, where the calling application and the end user are authenticated
          contact:
            name: API Management Support
            email: api.management@nhs.net
        servers:
          - url: 'https://sandbox.api.service.nhs.uk/specification/hello-world'
            description: Sandbox environment.
        paths:
          /hello/world:
            get:
              summary: Get a "Hello world!" response from an open-access endpoint
              operationId: getHello
              description: |
                ## Overview
                Use this endpoint alongside our [open-access REST API tutorial](https://digital.nhs.uk/developer/guides-and-documentation/tutorials/open-access-rest-api-tutorial) to learn how to connect to our APIs.
              responses:
                '200':
                  description: Successful response.
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          message:
                            type: string
                            example: Hello world!
                      example:
                        message: Hello world!
